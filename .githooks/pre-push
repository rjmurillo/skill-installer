#!/bin/bash
# Pre-push hook: Run CodeQL security analysis
# Runs full CodeQL scan before pushing to remote

set -e

echo "Running CodeQL security analysis..."

# Check if gh codeql is available
if ! command -v gh &> /dev/null || ! gh extension list | grep -q codeql; then
    echo "Warning: gh-codeql not installed. Skipping CodeQL analysis."
    echo "Install with: gh extension install github/gh-codeql"
    exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"
DB_PATH="${REPO_ROOT}/.codeql-db"
RESULTS_PATH="${REPO_ROOT}/.codeql-results"

# Clean up previous database
rm -rf "$DB_PATH" "$RESULTS_PATH"

# Create CodeQL database
echo "Creating CodeQL database..."
gh codeql database create "$DB_PATH" \
    --language=python \
    --source-root="$REPO_ROOT" \
    --overwrite \
    --quiet

# Run security queries
echo "Running security queries..."
gh codeql database analyze "$DB_PATH" \
    --format=sarif-latest \
    --output="${RESULTS_PATH}/results.sarif" \
    codeql/python-queries:codeql-suites/python-security-extended.qls \
    --quiet

# Check for high/critical severity issues
if command -v jq &> /dev/null; then
    HIGH_SEVERITY=$(jq '[.runs[].results[] | select(.level == "error" or .level == "warning")] | length' "${RESULTS_PATH}/results.sarif" 2>/dev/null || echo "0")
    if [ "$HIGH_SEVERITY" -gt 0 ]; then
        echo "CodeQL found $HIGH_SEVERITY security issue(s):"
        jq -r '.runs[].results[] | select(.level == "error" or .level == "warning") | "  - \(.ruleId): \(.message.text)"' "${RESULTS_PATH}/results.sarif"
        echo ""
        echo "Push blocked. Fix security issues before pushing."
        exit 1
    fi
fi

echo "CodeQL analysis passed. No security issues found."

# Clean up
rm -rf "$DB_PATH" "$RESULTS_PATH"

exit 0
