#!/bin/bash
# Pre-push hook: Run CodeQL security analysis via shared script
set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"
SCRIPT="$REPO_ROOT/.codeql/scripts/run-codeql.sh"

if [ ! -x "$SCRIPT" ]; then
    echo "CodeQL script missing or not executable: $SCRIPT" >&2
    echo "Run: chmod +x $SCRIPT" >&2
    exit 1
fi

# Audit log for tracking security scan bypasses
AUDIT_LOG="$REPO_ROOT/.codeql/bypass-audit.log"

log_bypass() {
    local reason="$1"
    local timestamp
    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local user
    user=$(git config user.email || echo "unknown")
    local branch
    branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    mkdir -p "$(dirname "$AUDIT_LOG")"
    echo "$timestamp | $user | $branch | $reason" >> "$AUDIT_LOG"
    echo "Bypass logged to $AUDIT_LOG" >&2
}

# Check for explicit bypass request
SKIP_CODEQL=${SKIP_CODEQL:-}
if [ "$SKIP_CODEQL" = "1" ]; then
    echo "WARNING: Security scan bypassed by SKIP_CODEQL=1" >&2
    log_bypass "SKIP_CODEQL=1 explicit bypass"
    exit 0
fi

if ! command -v gh >/dev/null 2>&1 || ! gh extension list | grep -q codeql; then
    echo "ERROR: gh-codeql not installed. Security scan required." >&2
    echo "Install with: gh extension install github/gh-codeql" >&2
    echo "To bypass (NOT RECOMMENDED): SKIP_CODEQL=1 git push" >&2
    exit 1
fi

$SCRIPT

exit 0
